# D-Link DIR-820L命令注入复现到新漏洞挖掘

## 漏洞信息

漏洞链接：https://nvd.nist.gov/vuln/detail/CVE-2022-26258

影响产品：DIR-820L 1.05 B03

固件下载地址：http://www.dlinktw.com.tw/techsupport/download.ashx?file=2663

## 漏洞分析

由漏洞信息得知，在路由的处理程序中`/lan.asp`，参数的值`Device Name`可以注入命令

知道漏洞触发位置，自行分析寻找漏洞点

![image-20220502204036659](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220502204036659.png)

推测这个二进制文件就是处理前端输入传入后端的，放入IDA分析，搜索device

![image-20220503213117500](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503213117500.png)



_system()函数第四个参数，执行了拼接后的命令，而在前有hasInjectionString()过滤，在文件系统搜索字符串

![image-20220503213422915](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503213422915.png)



![image-20220503214224132](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503214224132.png)



分析libleopard.so，过滤了一些截断符，但是并没有过滤换行符

![image-20220503214528604](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503214528604.png)

_system()调用了system，此外，libleopard.so还定义了exec_system()函数，但grep搜索后并未在其他二进制文件中引用

![image-20220503215229668](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503215229668.png)



## 漏洞复现

使用FirmAe仿真固件

![image-20220503221128187](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503221128187.png)

直接登录，默认不需要密码，在lan.asp

![image-20220503221932919](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503221932919.png)

将lanHostCfg_DeviceName_1.1.1.0值加上需要执行的命令，这里我尝试直接把值全部更改为执行的命令是失败的，后来在前面加上加一些其他字符串是成功的，在firmae调试的telnet里边，发包后看到并没有执行的命令，所以不知道是不是因为是仿真的原因，如果把预设命令直接当做devicename设置，截断会不起作用，没有做过多的研究，感兴趣可以动态调试看一下

![image-20220504103251909](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220504103251909.png)

成功getshell，命令执行成功

![image-20220504105940593](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220504105940593.png)

## 新漏洞挖掘

### 命令注入：

已知过滤函数没有过滤完全，通过查看hasInjectionString()函数引用寻找其他输入点

在nc22中，获取输入的ping_addr值，经过不完全的过滤，拼接后的字符串使用popen()执行，存在命令注入

![image-20220503235310888](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220503235310888.png)



对ping功能抓包，经测试，ping test和ipv6 ping test都存在命令注入，将ping_addr参数修改为%0Atelnetd%20-l%20%2Fbin%2Fsh%20-p%204444%0A，这个数据包cookie是比较简单的参数为1就行，经实际测试，无需最后的165参数（可能是时间戳）也可实现命令注入，所以是未授权命令执行

![image-20220504111422824](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220504111422824.png)

![image-20220504111446672](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220504111446672.png)

使用telnet连接目标4444端口，连接成功，获取设备shell，搜了一下，好像没有被提交过，算是捡的漏洞吧。

![image-20220504111528905](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220504111528905.png)





### 拒绝服务：

![image-20220505224136342](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220505224136342.png)

![image-20220505224117234](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220505224117234.png)

![image-20220505224447342](D-Link DIR-820L 命令注入漏洞分析.assets/image-20220505224447342.png)

此时已经无法登陆，由于是ncc2崩溃，也就是处理请求的二进制文件崩溃，http服务还正常，但已经不能处理请求了

## 总结

在找到命令注入漏洞后，存在过滤函数，说明开发者考虑到了注入风险，那么既然过滤不严格，其他输入点可能也存在过滤不严格的可能，此时通过查看过滤函数的引用去寻找其他可控输入点，会有可能发现更多的漏洞。

















